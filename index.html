<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PharmaNova â€” Agentic Prototype</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.2/css/bootstrap.min.css"/>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; }

  .summary-card { 
    background:#f8f9fa; 
    border-radius:6px; 
    padding:16px; 
    height:100%; 
    max-height: 420px;
    overflow-y: auto;
  }

  .chart-container {
    height: 260px !important;
  }

  /* Chatbot Floating Button */
  #chatIcon {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background:#0d6efd;
    width:60px;
    height:60px;
    border-radius:50%;
    color:white;
    font-size:30px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    box-shadow:0 4px 10px rgba(0,0,0,0.3);
    z-index: 999;
  }

  #chatWindow {
    position: fixed;
    bottom: 110px;
    right: 30px;
    width: 320px;
    height: 420px;
    background:white;
    border:1px solid #ccc;
    border-radius:10px;
    padding:10px;
    display:none;
    flex-direction:column;
    box-shadow:0 4px 15px rgba(0,0,0,0.3);
    z-index: 999;
  }

  #chatMessages {
    flex:1;
    overflow-y:auto;
    padding:5px;
  }

  #chatInput { width:100%; padding:8px; }
</style>
</head>
<body class="p-4">

<div class="container-fluid">

  <!-- Header -->
  <div class="row mb-3">
    <div class="col">
      <h2>PharmaNova â€” Agentic Repurposing Prototype</h2>
      <p class="muted">Search molecules or symptoms, explore repurposing opportunities, check patent status, and export PDF reports.</p>
    </div>
  </div>


  <!-- Filters + Summary -->
  <div class="row g-3 mb-3">
    <div class="col-lg-9">
      <div class="row g-2">
        
        <div class="col-md-3">
          <label class="form-label">Risk Level</label>
          <select id="riskFilter" class="form-select"><option value="All">All</option></select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Drug Prescribed</label>
          <select id="drugFilter" class="form-select"><option value="All">All</option></select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Side Effect</label>
          <select id="sideEffectFilter" class="form-select"><option value="All">All</option></select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Patent Status</label>
          <select id="patentFilter" class="form-select">
            <option value="All">All</option>
            <option>Active</option><option>Expired</option><option>No Patent</option>
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Repurposing Tag</label>
          <select id="repurposeFilter" class="form-select"><option value="All">All</option></select>
        </div>

        <div class="col-md-8">
          <label class="form-label">Search Molecule or Symptom</label>
          <input id="searchBox" class="form-control" placeholder="e.g., MolA, fever, diabetes">
        </div>

      </div>

      <div class="mt-3">
        <button id="filterBtn" class="btn btn-primary me-2">Apply</button>
        <button id="exportPdf" class="btn btn-warning me-2">Export PDF</button>
        <button id="resetBtn" class="btn btn-outline-secondary">Reset</button>
      </div>
    </div>

    <div class="col-lg-3">
      <div class="summary-card" id="summaryCard">
        <h5 id="summaryTitle">Executive Summary</h5>
        <p id="summaryText">Apply filters to see insights.</p>
        <hr/>
        <div id="summaryStats" class="small muted"></div>
      </div>
    </div>
  </div>


  <!-- Table + Charts -->
  <div class="row">
    <div class="col-lg-9">
      <table id="moleculeTable" class="display table table-striped" style="width:100%">
        <thead>
          <tr>
            <th>Molecule</th><th>Age</th><th>Gender</th><th>Symptoms</th><th>History</th>
            <th>Drug</th><th>Dosage</th><th>Freq</th><th>Side Effect</th>
            <th>Response</th><th>Diagnosis</th><th>Risk</th>
            <th>Repurpose</th><th>Patent</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="col-lg-3">
      <div class="card mb-3 p-3 chart-container">
        <canvas id="riskChart"></canvas>
      </div>
      <div class="card p-3 chart-container">
        <canvas id="repurposeChart"></canvas>
      </div>
    </div>
  </div>

</div>



<!-- CHATBOT ICON -->
<div id="chatIcon">ðŸ’¬</div>

<div id="chatWindow">
  <div id="chatMessages"></div>
  <input id="chatInput" placeholder="Ask PharmaNova..." />
</div>




<script>
/* ----------------------------------------------------
   EXISTING SYNTHETIC DATA GENERATION (UNCHANGED)
---------------------------------------------------- */
const molecules = [];
const moleculeNames = ["MolA","MolB","MolC","MolD","MolE","MolF","MolG","MolH","MolI","MolJ"];
const genders = ["Male","Female"];
const symptomsList = ["fever","cough","nausea","fatigue","breathlessness","headache","cold","chest pain","vomiting","body ache"];
const historyList = ["diabetes","heart_issue","hypertension","thyroid","none"];
const drugs = ["Paracetamol","Azithromycin","Aspirin","Ibuprofen","Metformin","Atorvastatin","Omeprazole","Cetrizine","Amoxicillin","Dolo-650"];
const dosages = ["250mg","500mg","650mg","5mg","10mg","20mg"];
const frequency = ["Once daily","Twice daily","Thrice daily","SOS","Weekly"];
const sideEffectsList = ["nausea","dizziness","rash","dry mouth","fatigue","none"];
const repurposePool = ["Inflammation","Neuropathy","Metabolic syndrome","Chronic pain","Cardio protection","Anti-infective","Respiratory","Autoimmune","Cognitive","Renal support"];
const patentStatusOptions = ["Active","Expired","No Patent"];

function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

for(const m of moleculeNames){
  for(let i=0;i<15;i++){
    const age = Math.floor(Math.random()*60)+18;

    const symptoms = Array.from(new Set([
      rand(symptomsList), rand(symptomsList), rand(symptomsList)
    ])).join(",");

    const repCount = Math.floor(Math.random()*3)+1;
    const repC = [];
    while(repC.length < repCount){
      const c = rand(repurposePool);
      if(!repC.includes(c)) repC.push(c);
    }

    molecules.push({
      molecule_name: m,
      age: age,
      gender: rand(genders),
      symptoms: symptoms,
      medical_history: rand(historyList),
      drug_prescribed: rand(drugs),
      drug_dosage: rand(dosages),
      drug_frequency: rand(frequency),
      side_effects_reported: rand(sideEffectsList),
      medication_response: rand(["Improving","Stable","No Improvement"]),
      diagnosis: "General",
      risk_level: rand(["High","Medium","Low"]),
      possible_repurposing: repC.join("|"),
      patent_status: rand(patentStatusOptions)
    });
  }
}


/* ----------------------------------------------------
   DATATABLE INIT
---------------------------------------------------- */
let table = $('#moleculeTable').DataTable({
  data: molecules,
  columns: [
    {data:"molecule_name"}, {data:"age"}, {data:"gender"}, {data:"symptoms"}, {data:"medical_history"},
    {data:"drug_prescribed"}, {data:"drug_dosage"}, {data:"drug_frequency"},
    {data:"side_effects_reported"}, {data:"medication_response"}, {data:"diagnosis"}, {data:"risk_level"},
    {data:"possible_repurposing"}, {data:"patent_status"}
  ],
  pageLength: 5,
  lengthChange: false,
  dom: 'lrtip'
});


/* ----------------------------------------------------
   POPULATE FILTERS
---------------------------------------------------- */
function populateFilters(){
  [...new Set(molecules.map(x=>x.drug_prescribed))]
    .forEach(d=> $('#drugFilter').append(`<option>${d}</option>`));

  [...new Set(molecules.map(x=>x.side_effects_reported))]
    .forEach(s=> $('#sideEffectFilter').append(`<option>${s}</option>`));

  const reps = [...new Set(molecules.flatMap(x=>x.possible_repurposing.split("|")))];
  reps.forEach(r=> $('#repurposeFilter').append(`<option>${r}</option>`));

  [...new Set(molecules.map(x=>x.risk_level))]
    .forEach(r=> $('#riskFilter').append(`<option>${r}</option>`));
}
populateFilters();


/* ----------------------------------------------------
   APPLY FILTERS + FIXED SUMMARY UPDATE
---------------------------------------------------- */
function applyFilters(){
  const risk = $('#riskFilter').val();
  const drug = $('#drugFilter').val();
  const side = $('#sideEffectFilter').val();
  const patent = $('#patentFilter').val();
  const repurpose = $('#repurposeFilter').val();
  const search = $('#searchBox').val().toLowerCase();

  const filtered = molecules.filter(m=>{
    if(risk!=="All" && m.risk_level!==risk) return false;
    if(drug!=="All" && m.drug_prescribed!==drug) return false;
    if(side!=="All" && m.side_effects_reported!==side) return false;
    if(patent!=="All" && m.patent_status!==patent) return false;
    if(repurpose!=="All" && !m.possible_repurposing.split("|").includes(repurpose)) return false;

    if(search){
      return (
        m.molecule_name.toLowerCase().includes(search) ||
        m.symptoms.toLowerCase().includes(search) ||
        m.medical_history.toLowerCase().includes(search) ||
        m.possible_repurposing.toLowerCase().includes(search)
      );
    }
    return true;
  });

  table.clear().rows.add(filtered).draw();
  updateCharts(filtered);
  updateSummaryCard(filtered, search);
}

$('#searchBox').on('input', applyFilters);
$('#filterBtn').click(applyFilters);

$('#resetBtn').click(()=>{
  $('select').val('All');
  $('#searchBox').val('');
  applyFilters();
});


/* ----------------------------------------------------
   SUMMARY FIXED â€” ALWAYS UPDATES PROPERLY
---------------------------------------------------- */
function updateSummaryCard(data){
  if(data.length === 0){
    $('#summaryTitle').text("Executive Summary");
    $('#summaryText').text("No matching records.");
    $('#summaryStats').text("");
    return;
  }

  $('#summaryTitle').text(`Summary â€” ${data.length} Records`);

  const ages = data.map(d=>+d.age);
  const risks = data.reduce((a,d)=>{ a[d.risk_level]=(a[d.risk_level]||0)+1; return a; },{});
  const patents = data.reduce((a,d)=>{ a[d.patent_status]=(a[d.patent_status]||0)+1; return a; },{});

  const repCounts = {};
  data.forEach(d=> d.possible_repurposing.split("|").forEach(t=>{
    repCounts[t] = (repCounts[t]||0)+1;
  }));

  const topRep = Object.entries(repCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || "N/A";

  $('#summaryText').text(
    `Age range: ${Math.min(...ages)} - ${Math.max(...ages)}. ` +
    `Top repurposing signal: ${topRep}.`
  );

  $('#summaryStats').html(`
    <strong>Risk:</strong> ${Object.entries(risks).map(e=>`${e[0]}: ${e[1]}`).join(" â€¢ ")}<br/>
    <strong>Patent:</strong> ${Object.entries(patents).map(e=>`${e[0]}: ${e[1]}`).join(" â€¢ ")}
  `);
}


/* ----------------------------------------------------
   CHARTS â€” IMPROVED SPACING
---------------------------------------------------- */
let riskChart, repurposeChart;

function updateCharts(data){
  const ctx1 = document.getElementById('riskChart').getContext('2d');
  const ctx2 = document.getElementById('repurposeChart').getContext('2d');

  if(riskChart) riskChart.destroy();
  if(repurposeChart) repurposeChart.destroy();

  const risks = data.reduce((a,d)=>{a[d.risk_level]=(a[d.risk_level]||0)+1; return a;},{});
  riskChart = new Chart(ctx1,{
    type:'pie',
    data:{
      labels:Object.keys(risks),
      datasets:[{data:Object.values(risks)}]
    },
    options:{responsive:true}
  });

  const repCounts = {};
  data.forEach(d=> d.possible_repurposing.split("|").forEach(t=>{
    repCounts[t]=(repCounts[t]||0)+1;
  }));

  const sorted = Object.entries(repCounts).sort((a,b)=>b[1]-a[1]).slice(0,8);

  repurposeChart = new Chart(ctx2,{
    type:'bar',
    data:{
      labels:sorted.map(x=>x[0]),
      datasets:[{data:sorted.map(x=>x[1])}]
    },
    options:{indexAxis:'y'}
  });
}

updateCharts(molecules);
updateSummaryCard(molecules);


/* ----------------------------------------------------
   SIMPLE CHATBOT PANEL
---------------------------------------------------- */
$("#chatIcon").click(()=>{
  $("#chatWindow").toggle();
});

$("#chatInput").keypress(function(e){
  if(e.key==="Enter"){
    let msg = $(this).val().trim();
    if(msg==="") return;

    $("#chatMessages").append(`<div><strong>You:</strong> ${msg}</div>`);
    $(this).val("");

    setTimeout(()=>{
      $("#chatMessages").append(`<div><strong>Bot:</strong> I understand your question about "${msg}". I will help you analyze molecules, repurposing, risks, patents or filters.</div>`);
      $("#chatMessages").scrollTop($("#chatMessages")[0].scrollHeight);
    },500);
  }
});
</script>

</body>
</html>
